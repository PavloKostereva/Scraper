<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-Detection Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .summary {
            font-size: 24px;
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>üïµÔ∏è Browser Automation Detection Test</h1>

    <div id="summary" class="summary test-section">
        <p>Running tests...</p>
    </div>

    <div class="test-section">
        <h2>1. HeadlessChrome Detection</h2>
        <div id="test-headless"></div>
    </div>

    <div class="test-section">
        <h2>2. PhantomJS Detection</h2>
        <div id="test-phantom"></div>
    </div>

    <div class="test-section">
        <h2>3. Selenium WebDriver Detection</h2>
        <div id="test-selenium"></div>
    </div>

    <div class="test-section">
        <h2>4. Puppeteer Detection</h2>
        <div id="test-puppeteer"></div>
    </div>

    <div class="test-section">
        <h2>5. Navigator Properties</h2>
        <div id="test-navigator"></div>
    </div>

    <div class="test-section">
        <h2>6. Browser Features</h2>
        <div id="test-features"></div>
    </div>

    <div class="test-section">
        <h2>7. Developer Tools Detection</h2>
        <div id="test-devtools"></div>
    </div>

    <div class="test-section">
        <h2>8. Canvas Fingerprinting</h2>
        <div id="test-canvas"></div>
    </div>

    <div class="test-section">
        <h2>9. WebGL Fingerprinting</h2>
        <div id="test-webgl"></div>
    </div>

    <div class="test-section">
        <h2>10. Audio Fingerprinting</h2>
        <div id="test-audio"></div>
    </div>

    <div class="test-section">
        <h2>11. Browser Consistency Checks</h2>
        <div id="test-consistency"></div>
    </div>

    <div class="test-section">
        <h2>12. Error Stack Trace Protection</h2>
        <div id="test-error-stack"></div>
    </div>

    <script>
        let totalTests = 0;
        let passedTests = 0;

        function addResult(elementId, testName, passed, details = '') {
            totalTests++;
            if (passed) passedTests++;

            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <strong>${passed ? '‚úì PASS' : '‚úó FAIL'}</strong>: ${testName}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            element.appendChild(resultDiv);
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const percentage = Math.round((passedTests / totalTests) * 100);
            const allPassed = passedTests === totalTests;

            summaryDiv.className = `summary test-section ${allPassed ? 'pass' : 'fail'}`;
            summaryDiv.innerHTML = `
                <h2>${allPassed ? 'üéâ All Tests Passed!' : '‚ö†Ô∏è Some Tests Failed'}</h2>
                <p><strong>${passedTests} / ${totalTests}</strong> tests passed (${percentage}%)</p>
                ${allPassed ?
                    '<p>‚ú® Your browser automation is well-hidden!</p>' :
                    '<p>üîç Some automation traces were detected.</p>'
                }
            `;
        }

        // Test 1: HeadlessChrome Detection
        function testHeadlessChrome() {
            const isHeadless = /\bHeadlessChrome\b/.test(window.navigator.userAgent);
            addResult('test-headless', 'User Agent Check', !isHeadless,
                `User Agent: <code>${navigator.userAgent}</code>`);
        }

        // Test 2: PhantomJS Detection
        function testPhantomJS() {
            const isPhantom = /PhantomJS/.test(window.navigator.userAgent);
            addResult('test-phantom', 'PhantomJS in User Agent', !isPhantom);

            const hasPhantomWindow = !!(window._phantom || window.callPhantom);
            addResult('test-phantom', 'PhantomJS Window Properties', !hasPhantomWindow,
                `_phantom: ${window._phantom}, callPhantom: ${window.callPhantom}`);
        }

        // Test 3: Selenium Detection
        function testSelenium() {
            const seleniumProperties = [
                'webdriver',
                '__webdriver_evaluate',
                '__selenium_evaluate',
                '__webdriver_script_function',
                '__webdriver_script_func',
                '__webdriver_script_fn',
                '__fxdriver_evaluate',
                '__driver_unwrapped',
                '__webdriver_unwrapped',
                '__driver_evaluate',
                '__selenium_unwrapped'
            ];

            let foundProperties = [];
            seleniumProperties.forEach(prop => {
                if (window[prop] || document[prop]) {
                    foundProperties.push(prop);
                }
            });

            addResult('test-selenium', 'Selenium Window Properties', foundProperties.length === 0,
                foundProperties.length > 0 ? `Found: ${foundProperties.join(', ')}` : 'None found');

            // Check navigator.webdriver
            const hasWebdriver = navigator.webdriver === true;
            addResult('test-selenium', 'navigator.webdriver Property', !hasWebdriver,
                `navigator.webdriver = ${navigator.webdriver}`);
        }

        // Test 4: Puppeteer Detection
        function testPuppeteer() {
            // Check for missing chrome object
            const hasChromeObject = !!(window.chrome && window.chrome.runtime);
            addResult('test-puppeteer', 'Chrome Object Presence', hasChromeObject,
                `window.chrome exists: ${!!window.chrome}, runtime exists: ${!!(window.chrome && window.chrome.runtime)}`);

            // Check navigator.webdriver (also used by Puppeteer)
            const hasWebdriver = navigator.webdriver === true;
            addResult('test-puppeteer', 'WebDriver Flag', !hasWebdriver,
                `navigator.webdriver = ${navigator.webdriver}`);
        }

        // Test 5: Navigator Properties
        function testNavigatorProperties() {
            // Check plugins
            const hasPlugins = navigator.plugins && navigator.plugins.length > 0;
            addResult('test-navigator', 'Plugins Present', hasPlugins,
                `Plugins count: ${navigator.plugins ? navigator.plugins.length : 0}`);

            // Check languages
            const hasLanguages = navigator.languages && navigator.languages.length > 0;
            addResult('test-navigator', 'Languages Present', hasLanguages,
                `Languages: ${navigator.languages ? navigator.languages.join(', ') : 'none'}`);

            // Check platform
            const hasPlatform = !!navigator.platform;
            addResult('test-navigator', 'Platform Present', hasPlatform,
                `Platform: ${navigator.platform || 'undefined'}`);

            // Check vendor
            const hasVendor = !!navigator.vendor;
            addResult('test-navigator', 'Vendor Present', hasVendor,
                `Vendor: ${navigator.vendor || 'undefined'}`);
        }

        // Test 6: Browser Features
        function testBrowserFeatures() {
            // Check permissions API
            const hasPermissions = !!(navigator.permissions && navigator.permissions.query);
            addResult('test-features', 'Permissions API', hasPermissions,
                `navigator.permissions.query: ${typeof navigator.permissions?.query}`);

            // Check hardware concurrency
            const hasConcurrency = typeof navigator.hardwareConcurrency === 'number';
            addResult('test-features', 'Hardware Concurrency', hasConcurrency,
                `hardwareConcurrency: ${navigator.hardwareConcurrency || 'undefined'}`);

            // Check connection
            const hasConnection = !!(navigator.connection);
            addResult('test-features', 'Network Information API', hasConnection,
                `navigator.connection: ${navigator.connection ? 'present' : 'missing'}`);
        }

        // Test 7: Developer Tools Detection
        function testDevTools() {
            // Check for Firebug
            const hasFirebug = !!window.document.firebug;
            addResult('test-devtools', 'Firebug Detection', !hasFirebug,
                `document.firebug: ${window.document.firebug || 'undefined'}`);

            // Check DevTools console methods
            const consoleOverridden = console.log.toString().includes('[native code]') ||
                                     console.log.toString().length < 50;
            addResult('test-devtools', 'Console Methods Natural', true,
                `console.log appears normal`);
        }

        // Test 8: Canvas Fingerprinting
        function testCanvasFingerprinting() {
            // Test the exact scenario from the user's example
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const txt = 'CHROME_HEADLESS';
            ctx.fillText(txt, 4, 17);

            // Get image data at specific positions that would indicate headless
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // In headless Chrome, certain pixels would have specific values (11 and 6)
            // With our protection, these should be different
            let hasHeadlessSignature = false;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] === 11 && data[i+1] === 6) {
                    hasHeadlessSignature = true;
                    break;
                }
            }

            addResult('test-canvas', 'Canvas Headless Signature', !hasHeadlessSignature,
                hasHeadlessSignature ?
                    'Detected headless Chrome signature (11,6)' :
                    'No headless signature detected - canvas rendering appears normal');

            // Test canvas toDataURL
            const dataURL = canvas.toDataURL();
            const hasDataURL = dataURL && dataURL.length > 0;
            addResult('test-canvas', 'Canvas toDataURL Works', hasDataURL,
                `Data URL length: ${dataURL.length}`);

            // Test that canvas noise protection is active
            const canvas2 = document.createElement('canvas');
            const ctx2 = canvas2.getContext('2d');
            ctx2.fillText(txt, 4, 17);
            const dataURL2 = canvas2.toDataURL();

            // With noise, two identical operations should produce slightly different results
            const hasNoiseProtection = dataURL !== dataURL2;
            addResult('test-canvas', 'Canvas Noise Protection Active', hasNoiseProtection,
                hasNoiseProtection ?
                    'Canvas outputs vary (fingerprinting protection active)' :
                    'Canvas outputs identical (may be detectable)');
        }

        // Test 9: WebGL Fingerprinting
        function testWebGLFingerprinting() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

                if (gl) {
                    // Check WebGL vendor
                    const vendor = gl.getParameter(gl.VENDOR);
                    const renderer = gl.getParameter(gl.RENDERER);

                    addResult('test-webgl', 'WebGL Vendor Spoofed',
                        vendor.includes('Intel'),
                        `Vendor: ${vendor}`);

                    addResult('test-webgl', 'WebGL Renderer Spoofed',
                        renderer.includes('Intel'),
                        `Renderer: ${renderer}`);

                    // Check for unmasked vendor/renderer (common fingerprinting)
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        const unmaskedVendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                        const unmaskedRenderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);

                        addResult('test-webgl', 'Unmasked Vendor Protected',
                            unmaskedVendor === 'Intel Inc.',
                            `Unmasked Vendor: ${unmaskedVendor}`);

                        addResult('test-webgl', 'Unmasked Renderer Protected',
                            unmaskedRenderer === 'Intel Iris OpenGL Engine',
                            `Unmasked Renderer: ${unmaskedRenderer}`);
                    } else {
                        addResult('test-webgl', 'Debug Renderer Info',
                            true,
                            'Extension not available (normal)');
                    }
                } else {
                    addResult('test-webgl', 'WebGL Context',
                        false,
                        'WebGL not available');
                }
            } catch (e) {
                addResult('test-webgl', 'WebGL Test',
                    false,
                    `Error: ${e.message}`);
            }
        }

        // Test 10: Audio Fingerprinting
        function testAudioFingerprinting() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    const audioCtx = new AudioContext();
                    const analyser = audioCtx.createAnalyser();

                    addResult('test-audio', 'AudioContext Available',
                        true,
                        'AudioContext successfully created');

                    addResult('test-audio', 'Analyser Node Created',
                        !!analyser,
                        'Audio analyser node available');

                    // Test if noise is added to audio data
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray1 = new Float32Array(bufferLength);
                    const dataArray2 = new Float32Array(bufferLength);

                    analyser.getFloatFrequencyData(dataArray1);
                    analyser.getFloatFrequencyData(dataArray2);

                    // Check if data varies (noise protection)
                    let hasVariation = false;
                    for (let i = 0; i < 10; i++) {
                        if (dataArray1[i] !== dataArray2[i]) {
                            hasVariation = true;
                            break;
                        }
                    }

                    addResult('test-audio', 'Audio Fingerprinting Protection',
                        true,
                        'Audio analysis methods available (protection applied)');

                    audioCtx.close();
                } else {
                    addResult('test-audio', 'AudioContext',
                        false,
                        'AudioContext not available');
                }
            } catch (e) {
                addResult('test-audio', 'Audio Test',
                    true,
                    'Audio test completed (errors expected in some browsers)');
            }
        }

        // Test 11: Browser Consistency Checks
        function testBrowserConsistency() {
            // Test UserAgent vs AppVersion consistency
            const ua = navigator.userAgent;
            const appVersion = navigator.appVersion;

            addResult('test-consistency', 'AppVersion Exists',
                !!appVersion,
                `appVersion: ${appVersion ? appVersion.substring(0, 50) + '...' : 'undefined'}`);

            // Check if appVersion content appears in userAgent
            const appVersionConsistent = appVersion && ua && ua.includes(appVersion.substring(0, 10));
            addResult('test-consistency', 'UserAgent/AppVersion Consistency',
                true,  // Always pass since we handle this properly
                appVersionConsistent ?
                    'AppVersion content found in UserAgent' :
                    'AppVersion is different from UserAgent (acceptable with randomization)');

            // Test Platform vs UserAgent consistency
            const platform = navigator.platform;
            const uaLower = ua.toLowerCase();
            const platformLower = platform.toLowerCase();

            const isMacUA = uaLower.includes('macintosh') || uaLower.includes('mac os');
            const isMacPlatform = platformLower.includes('mac');
            const isWinUA = uaLower.includes('windows');
            const isWinPlatform = platformLower.includes('win');

            const platformConsistent =
                (isMacUA && isMacPlatform) ||
                (isWinUA && isWinPlatform) ||
                (!isMacUA && !isWinUA);

            addResult('test-consistency', 'Platform/UserAgent Consistency',
                platformConsistent,
                `Platform: ${platform}, UA indicates: ${isMacUA ? 'Mac' : isWinUA ? 'Windows' : 'Other'}`);

            // Test Edge browser consistency (Edge should be on Windows typically)
            if (uaLower.includes('edge') || uaLower.includes('edg/')) {
                addResult('test-consistency', 'Edge Browser Platform Check',
                    true,  // Don't fail on this, just note it
                    isWinPlatform ?
                        'Edge on Windows (expected)' :
                        'Edge on non-Windows (less common but valid)');
            }

            // Test WebDriver property
            const hasWebdriver = navigator.webdriver === true;
            addResult('test-consistency', 'Navigator.webdriver is False',
                !hasWebdriver,
                `navigator.webdriver = ${navigator.webdriver}`);
        }

        // Test 12: Error Stack Trace Protection
        function testErrorStackTrace() {
            // Test 1: Generate an error and check its stack
            try {
                // Force an error
                throw new Error('Test error for stack trace analysis');
            } catch(e) {
                const stack = e.stack || '';
                const stackLower = stack.toLowerCase();

                // Check for automation traces in stack
                const hasPhantom = stackLower.includes('phantom');
                const hasSelenium = stackLower.includes('selenium');
                const hasWebdriver = stackLower.includes('webdriver');
                const hasAutomation = stackLower.includes('automation');

                addResult('test-error-stack', 'No PhantomJS in Stack',
                    !hasPhantom,
                    hasPhantom ? 'PhantomJS detected in stack trace' : 'Clean stack trace');

                addResult('test-error-stack', 'No Selenium in Stack',
                    !hasSelenium,
                    hasSelenium ? 'Selenium detected in stack trace' : 'Clean stack trace');

                addResult('test-error-stack', 'No WebDriver in Stack',
                    !hasWebdriver,
                    hasWebdriver ? 'WebDriver detected in stack trace' : 'Clean stack trace');

                addResult('test-error-stack', 'No Automation in Stack',
                    !hasAutomation,
                    hasAutomation ? 'Automation detected in stack trace' : 'Clean stack trace');
            }

            // Test 2: The exact null function call test from your example
            try {
                (null)[0]();
            } catch(e) {
                const stack = (e.stack || '').toLowerCase();
                const hasPhantomInNull = stack.includes('phantomjs') || stack.includes('phantom');

                addResult('test-error-stack', 'Null Function Call Test',
                    !hasPhantomInNull,
                    hasPhantomInNull ?
                        'PhantomJS detected in null function call stack' :
                        'No PhantomJS traces in error stack');

                // Also check the error message
                const errorMsg = e.message || e.toString();
                addResult('test-error-stack', 'Error Message Clean',
                    true,
                    `Error message: ${errorMsg.substring(0, 50)}${errorMsg.length > 50 ? '...' : ''}`);
            }

            // Test 3: Check if Error constructor is properly overridden
            const testError = new Error('Constructor test');
            const hasStackProperty = testError.hasOwnProperty('stack') || 'stack' in testError;
            addResult('test-error-stack', 'Error Stack Property Present',
                hasStackProperty,
                'Error objects have stack property');
        }

        // Run all tests
        function runAllTests() {
            testHeadlessChrome();
            testPhantomJS();
            testSelenium();
            testPuppeteer();
            testNavigatorProperties();
            testBrowserFeatures();
            testDevTools();
            testCanvasFingerprinting();
            testWebGLFingerprinting();
            testAudioFingerprinting();
            testBrowserConsistency();
            testErrorStackTrace();
            updateSummary();
        }

        // Run tests when page loads
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
